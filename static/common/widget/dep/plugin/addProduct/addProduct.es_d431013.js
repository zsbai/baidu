define("common:widget/dep/plugin/addProduct/addProduct.es",function(require,exports,module){"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{"default":t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,a,i){return a&&t(e.prototype,a),i&&t(e,i),e}}(),_commonWidgetJsUtilTangramTangramJs=require("common:widget/js/util/tangram/tangram"),_commonWidgetJsUtilTangramTangramJs2=_interopRequireDefault(_commonWidgetJsUtilTangramTangramJs),_commonWidgetJsUiPopTipPopTipJs=require("common:widget/js/ui/pop-tip/pop-tip"),_commonWidgetJsUiPopTipPopTipJs2=_interopRequireDefault(_commonWidgetJsUiPopTipPopTipJs);require("common:widget/dep/plugin/addProduct/addProduct.css");var Dialog=require("common:widget/js/ui/dialog/dialog");require("common:widget/dep/plugin/content-plugin-sdk/content-plugin-sdk");var tpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="ueditor-add-product">        <div class="add-product-mask"></div>        <div class="product-editor-module">        <div class="header">            <div class="left">                <span class="back"></span>                <span class="goback">返回</span>                <span class="dash"></span>                <span>商品详情</span>            </div>            <div class="close"></div>        </div>        <div class="product-name common">            <span class="name">商品标题</span>            <input class="title" />        </div>        <div class="show-pic common">            <div>                <span class="img-label">展示图片</span>                <img class="cover" src="" />            </div>            <div class="choice-cover">                <p>请选择一张图片作为商品封面</p>                <div id="img-list"></div>            </div>        </div>        <div class="product-price common">            <span>商品价格</span>            <span class="price"></span>            <span class="line"></span>            <span class="coupons">可用券</span>            <span class="coupons-value"></span>        </div>        <div class="btn-wrapper">            <button class="cancel btn-common">取消</button>            <button class="confirm btn-common">确定</button>        </div>    </div></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0](),TIME_OUT=1500,AddProduct=function(){function t(e,a,i){if(_classCallCheck(this,t),e&&a){var n=_commonWidgetJsUtilTangramTangramJs2["default"](tpl);_commonWidgetJsUtilTangramTangramJs2["default"]("body").append(n),this.$el=n,this.UE=e;var o=this;this.itemIdList=[],this.userQuantityInfo={},this.isQuantityUser(),e.registerUI(a,function(t,a){o.editor=t;var i=new e.ui.Button({name:a,className:"edui-for-addproduct",title:"添加商品",onclick:function(){if(window.addProSuccessByBtn===!0)return void _commonWidgetJsUiPopTipPopTipJs2["default"]("只允许带一种类型的商品哦~");if(0===o.userQuantityInfo.isQuality)return void _commonWidgetJsUiPopTipPopTipJs2["default"]("累计发布≥3篇精华长图文的用户，即可发布带有淘宝商品的内容产生收益");if(1===o.userQuantityInfo.isQuality&&0===o.userQuantityInfo.tbPid)return void Dialog.alert('<div class="guide-bind-taobao"><div class="title">绑定淘宝联盟PID</div><div class="content">在<a class="gotoTarget" href="/fans/ucenter?type=4">高级设置</a>中绑定淘宝联盟PID,即可在发帖时插入<br/>淘宝商品获得佣金</div>',{width:400,buttons:[{text:"确定",click:function(){Dialog.close()}}]});if(o.getWordsNum(t.getContent())<50)return void _commonWidgetJsUiPopTipPopTipJs2["default"]("文章开头必须大于等于50个文字才允许添加商品哦~");if(10===o.itemIdList.length)return void _commonWidgetJsUiPopTipPopTipJs2["default"]("最多添加十个商品哦~");if(o.show(),t.focus(),MM_DAREN_PLUGIN){var e=new MM_DAREN_PLUGIN({appkey:29163871,pid:"mm_619110066_1447850355_110740650167",subpid:o.userQuantityInfo.tbPid,maxItemNum:1,minItemNum:1,addClass:"tb_module"});o.$plugin=e,e.on("selected",o.getChoicedProduct.bind(o)),e.on("close",function(){o.hide()})}}});return t.addListener("afterExecCommand",function(){t.body.focus()}),t.addListener("destroy",function(){o.$el.remove()}),t.addListener("selectionchange",function(){var t=this.queryCommandState(a);i.setDisabled(-1===t?!0:!1)}),i},[i]),this.bindEvent()}}return _createClass(t,[{key:"getWordsNum",value:function(t){t&&(t=t.split('<p class="product-card-box" contenteditable="false"')[0]);var e=document.createElement("div");e.style.display="none",_commonWidgetJsUtilTangramTangramJs2["default"](e).html(t);var a=_commonWidgetJsUtilTangramTangramJs2["default"](e).text()||"";return a.trim().length}},{key:"isQuantityUser",value:function(){var t=this;_commonWidgetJsUtilTangramTangramJs2["default"].ajax({type:"GET",url:"/mybaby/user/checkqualityuser",timeout:3e4,dataType:"json",success:function(e){if(t.userQuantityInfo=e.data||{},(0===t.userQuantityInfo.isQuality||1===t.userQuantityInfo.isQuality&&0===t.userQuantityInfo.tbPid)&&setTimeout(function(){_commonWidgetJsUtilTangramTangramJs2["default"](".edui-for-addproduct").addClass("edui-for-addproduct-disabled")},300),1===t.userQuantityInfo.isQuality){var a=localStorage.getItem("isFirstVisitPicPaste"),i=localStorage.getItem("isSuccessPubPicPaste");a||(localStorage.setItem("isFirstVisitPicPaste",!0),t.addTipModuleTwo()),i||t.addTipModuleOne()}},error:function(){}})}},{key:"show",value:function(){this.$el.show()}},{key:"hide",value:function(){this.$el.hide(),this.$plugin.off("selected",this.getChoicedProduct),this.$plugin.destory()}},{key:"getChoicedProduct",value:function(t){this.productInfo=t.itemList||[],t&&(this.renderProductModule(this.productInfo),this.$plugin.hide(),_commonWidgetJsUtilTangramTangramJs2["default"](".product-editor-module").show())}},{key:"clsoeModule",value:function(t){t.preventDefault(),this.hide()}},{key:"addTipModuleOne",value:function(){var t='<div class="insertRuleTips">仅支持在同一处挂载多个商品或在不同处插入单个商品哦（两种带货方式不能并存于一篇文章）~</div>';setTimeout(function(){_commonWidgetJsUtilTangramTangramJs2["default"](".mini-editor").append(t)},TIME_OUT)}},{key:"addTipModuleTwo",value:function(){var t='<div class="insertUseTips"><p class="tipContent">点击这里可在文中添加与内容相关的商品哦~</p><p class="btnKnow">知道了</p></div>';setTimeout(function(){_commonWidgetJsUtilTangramTangramJs2["default"](".mini-editor").append(t),_commonWidgetJsUtilTangramTangramJs2["default"](document).on("click",function(){_commonWidgetJsUtilTangramTangramJs2["default"](".insertUseTips").hide()})},TIME_OUT)}},{key:"bindEvent",value:function(){var t=this;_commonWidgetJsUtilTangramTangramJs2["default"](".product-editor-module .cancel").on("click",t.clsoeModule.bind(t)),_commonWidgetJsUtilTangramTangramJs2["default"](".product-editor-module .close").on("click",t.clsoeModule.bind(t)),_commonWidgetJsUtilTangramTangramJs2["default"](".product-editor-module .confirm").on("click",function(e){e.preventDefault();var a=_commonWidgetJsUtilTangramTangramJs2["default"](".product-editor-module .product-name .title").val();return a.length<5?void _commonWidgetJsUiPopTipPopTipJs2["default"]("商品标题必须大于等于5个字哦~"):void t.insertProductCard(t.productInfo)}),_commonWidgetJsUtilTangramTangramJs2["default"](".product-editor-module #img-list").on("click",function(t){t=t||event,t.preventDefault();var e=t.target||t.srcElement;if("img"===e.nodeName.toLowerCase()){_commonWidgetJsUtilTangramTangramJs2["default"](e).siblings().removeClass("img-choiced"),_commonWidgetJsUtilTangramTangramJs2["default"](e).addClass("img-choiced");var a=e.getAttribute("src");_commonWidgetJsUtilTangramTangramJs2["default"](".ueditor-add-product .cover").attr("src",a)}}),setTimeout(function(){var e=window.frames.ueditor_iframe;e&&!function(){var a=e.document;_commonWidgetJsUtilTangramTangramJs2["default"](a).ready(function(){function e(){setTimeout(function(){var e=[];_commonWidgetJsUtilTangramTangramJs2["default"](a).find(".product-card-box").each(function(){var t=_commonWidgetJsUtilTangramTangramJs2["default"](this).attr("data-itemId");t&&e.push(t)}),t.itemIdList=e},100)}_commonWidgetJsUtilTangramTangramJs2["default"](a).on("mouseover",".product-card-box",function(){_commonWidgetJsUtilTangramTangramJs2["default"](this).find(".delete").show()}),_commonWidgetJsUtilTangramTangramJs2["default"](a).on("mouseleave",".product-card-box",function(){_commonWidgetJsUtilTangramTangramJs2["default"](this).find(".delete").hide()}),_commonWidgetJsUtilTangramTangramJs2["default"](a).on("click",".product-card-box .delete",function(e){e.preventDefault();var a=_commonWidgetJsUtilTangramTangramJs2["default"](this).parents(".product-card-box").attr("data-itemId");if(_commonWidgetJsUtilTangramTangramJs2["default"](this).parents(".product-card-box").remove(),a){var i=t.itemIdList.indexOf(a);t.itemIdList.splice(i,1)}}),e(),_commonWidgetJsUtilTangramTangramJs2["default"](a).keydown(function(t){(8===t.keyCode||46===t.keyCode)&&e()})})}()},TIME_OUT)}},{key:"renderProductModule",value:function(t){if(t){var e=t[0]||{};_commonWidgetJsUtilTangramTangramJs2["default"](".product-editor-module .product-name .title").val(e.title),_commonWidgetJsUtilTangramTangramJs2["default"](".product-editor-module .cover").attr("src",""+e.pictUrls[0]),_commonWidgetJsUtilTangramTangramJs2["default"](".product-editor-module .product-price .price").text(e.discountPrice),_commonWidgetJsUtilTangramTangramJs2["default"](".product-editor-module .product-price .coupons-value").text((e.amout||0)+"元");for(var a=e.pictUrls||[],i="",n=0,o=a.length;o>n;n++)i+='<img src= "'+a[n]+'" class="'+(0===n?"img-choiced":"")+'" />';_commonWidgetJsUtilTangramTangramJs2["default"](".product-editor-module #img-list").html(i)}}},{key:"insertProductCard",value:function(t){if(t){var e=this,a=t[0]||{},i=e.itemIdList.indexOf(a.itemId);if(i>-1)return e.hide(),void _commonWidgetJsUiPopTipPopTipJs2["default"]("该商品已添加，请重新选择");var n=_commonWidgetJsUtilTangramTangramJs2["default"](".product-editor-module .cover").attr("src"),o=_commonWidgetJsUtilTangramTangramJs2["default"](".product-editor-module .product-name .title").val(),s='<p class="product-card-box" contenteditable="false" data-itemId="'+a.itemId+'"><span class="float cover-box"><img class="cover" src="'+n+'" /></span><span class="float information"><span class="title" data-original-title="'+a.title+'">'+o+'</span><span class="price" data-original-price="'+a.reservePrice+'">'+a.discountPrice+'</span><span class="channel">淘宝</span></span><span class="float purchase"  data-href="'+a.clickUrl+'">购买</span><span class="delete" style="display:none;"></span></p>';e.hide(),this.editor&&this.editor.execCommand("inserthtml",s),e.itemIdList.push(a.itemId),window.addProSuccessByUeditorBtn=!0}}}]),t}();exports["default"]=AddProduct,module.exports=exports["default"]});