define("common:widget/dep/plugin/insertImage/insertImage.es",function(require,exports,module){"use strict";function _interopRequireDefault(i){return i&&i.__esModule?i:{"default":i}}function _classCallCheck(i,e){if(!(i instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function i(i,e){for(var t=0;t<e.length;t++){var a=e[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(i,a.key,a)}}return function(e,t,a){return t&&i(e.prototype,t),a&&i(e,a),e}}(),_commonWidgetJsUtilTangramTangramJs=require("common:widget/js/util/tangram/tangram"),_commonWidgetJsUtilTangramTangramJs2=_interopRequireDefault(_commonWidgetJsUtilTangramTangramJs),_commonWidgetJsUiPopTipPopTipJs=require("common:widget/js/ui/pop-tip/pop-tip"),_commonWidgetJsUiPopTipPopTipJs2=_interopRequireDefault(_commonWidgetJsUiPopTipPopTipJs),_commonWidgetJsUtilWebuploaderWebuploaderMinJs=require("common:widget/js/util/webuploader/webuploader.min"),_commonWidgetJsUtilWebuploaderWebuploaderMinJs2=_interopRequireDefault(_commonWidgetJsUtilWebuploaderWebuploaderMinJs);require("common:widget/dep/plugin/insertImage/insertImage.css");var tpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="ueditor-new-insert-image">        <div class="insert-image-mask"></div>        <div class="insert-image-dialog">                <div class="insert-image-close">            <span class="close-btn iknow-ueditor-icons"></span>        </div>                <div class="insert-image-tab">            <div class="tab-item tab-local" data-type="local">本地图片</div>            <div class="tab-item tab-lib" data-type="lib">免费正版图库</div>        </div>                <div class="insert-image-panel">                        <div class="panel-local">                                <div class="local-upload-preview">                    <div class="preview-tip"></div>                    <div class="preview-upload">                                                <div class="upload-btn-content">                          <div class="upload-btn-icon">+</div>                        </div>                    </div>                </div>                                <div class="local-upload-area">                    <div class="local-upload-btn" id="local-upload-btn">                                                <div class="upload-btn-content">                          <div class="upload-btn-icon iknow-ueditor-icons"></div>                          <div class="upload-btn-desc">本地上传</div>                        </div>                    </div>                    <div class="local-upload-tip">支持jpg、jpeg、png等多种格式，单张图片最大支持20M</div>                </div>            </div>                        <div class="panel-lib">                                <div class="lib-search-wrapper">                    <input class="search-input" placeholder="请输入关键词，查找相关图片素材" /><span class="search-btn                    iknow-ueditor-icons"></span>                </div>                                <div class="lib-content-area">                                        <div class="content-default">                        <div class="default-content">                            库中的图片仅限在宝宝知道编辑内容时使用，不得用于其他任何平台及用户<br />                            请阅读                            <a target="blank" href="https://baobao.baidu.com/article/00a590d9a51407f75e9efb35ac8aaed6.html">《宝宝知道图片许可使用协议》</a>，当您开始使用时视为您已同意该协议                        </div>                    </div>                                        <div class="content-list">                        <div class="list-col">                        </div><div class="list-col">                        </div><div class="list-col">                        </div><div class="list-col">                        </div><div class="list-col"></div>                    </div>                                        <div class="content-noresult">                        <div class="noresult-img iknow-ueditor-icons"></div>                        <div class="noresult-text">                            未查找到相关图片<br />                            换个关键词搜索吧                        </div>                    </div>                                        <div class="content-loading">                        <div class="loading-animation">                            <span class="loading-shallow"></span><span class="loading-dark"></span>                        </div>                    </div>                </div>            </div>        </div>                <div class="insert-image-button">            <div class="button-item button-cancel">取消</div>            <div class="button-item button-ok">完成</div>        </div>    </div></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0](),localTabName="local",libTabName="lib",imgFromBjhAttr="iknow-image-from-bjh",InsertImage=function(){function i(e,t,a){if(_classCallCheck(this,i),e&&t){var s=_commonWidgetJsUtilTangramTangramJs2["default"](tpl);_commonWidgetJsUtilTangramTangramJs2["default"]("body").append(s),this.$el=s,this.UE=e,this.viewStatus=0,this.$libTab=s.find(".tab-lib"),this.$libTab.hide(),this.$libPanel=s.find(".panel-lib"),this.$libInput=this.$libPanel.find(".search-input"),this.$list=this.$libPanel.find(".content-list"),this.$libDefault=this.$libPanel.find(".content-default"),this.$libNoResult=this.$libPanel.find(".content-noresult"),this.$libLoading=this.$libPanel.find(".content-loading"),this.$cols=this.$list.find(".list-col"),this.hasMore=0,this.libBase=0,this.libRn=20,this.insertColIndex=0,this.colNum=this.$cols.size(),this.query=null,this.loadingList=!1,this.libInserting=!1,this.libInsertArr=[],this.$localTab=s.find(".tab-local"),this.$localPanel=s.find(".panel-local"),this.$uploadArea=this.$localPanel.find(".local-upload-area"),this.$preview=this.$localPanel.find(".local-upload-preview"),this.$previewUpload=this.$preview.find(".preview-upload"),this.$previewTip=this.$preview.find(".preview-tip"),this.hasInit=!1,this.fileCount=0,this.loadedCount=0,this.tabs={current:localTabName,map:{local:{tab:this.$localTab,panel:this.$localPanel},lib:{tab:this.$libTab,panel:this.$libPanel}}},this.switchTab(this.tabs.current),this.bindEvent(),this.isShowLib(this.$libTab);var n=this;e.registerUI(t,function(i,t){var a=this;n.editor=i,n.needHttpsAutoTrans=i.getOpt("needHttpsAutoTrans");var s=new e.ui.Button({name:t,className:"edui-for-insertimage",title:"添加图片",onclick:function(){!n.hasInit&&n.initUploadFn(i),n.viewStatus=1,n.show()}});return this.sendImageFromLibLog=function(){for(var i=a.getContent(),e=i.split(imgFromBjhAttr).length-1,t=0;e>t;t++){var s="bd_iknowbaby_log_"+Math.floor(2147483648*Math.random()).toString(36),n=new Image,o="https://ttl-bjh.baidu.com/cms/statistics/statistics/img/s.gif?",l={urlkey:"AB832R1ZSS",client_type:"pc",page_url:window.location.href,op_time:(new Date).getTime(),random:s,bjh_param:{res_id:""}};o+=_commonWidgetJsUtilTangramTangramJs2["default"].param(l),window[s]=n,function(i,e){i.onload=i.onerror=i.onabort=function(){i.onload=i.onerror=i.onabort=null,window[e]=null,i=null,e=null}}(n,s),n.src=o}return e},i.addListener("afterExecCommand",function(){i.body.focus()}),i.addListener("destroy",function(){n.$el.remove()}),s},[a])}}return _createClass(i,[{key:"switchTab",value:function(i){if(i){var e=this.tabs.map,t=this.tabs.current,a=e[t].tab,s=e[t].panel,n=e[i].tab,o=e[i].panel;a.removeClass("active"),s.hide(),n.addClass("active"),o.show(),this.tabs.current=i}}},{key:"stopScroll",value:function(i){var e=_commonWidgetJsUtilTangramTangramJs2["default"](i.target);e.hasClass("content-list")||e.hasClass("list-col")||e.hasClass("list-col")||e.hasClass("img-item")||i.preventDefault()}},{key:"show",value:function(){try{window.addEventListener("mousewheel",this.stopScroll,{passive:!1}),window.addEventListener("DOMMouseScroll",this.stopScroll,{passive:!1})}catch(i){}this.$el.show()}},{key:"hide",value:function(){try{window.removeEventListener("mousewheel",this.stopScroll),window.removeEventListener("DOMMouseScroll",this.stopScroll)}catch(i){}this.$el.hide(),this.viewStatus=0,this.switchTab(localTabName),this.fileCount=0,this.loadedCount=0,this.$previewTip.text(""),this.$previewUpload.show(),this.$preview.find(".preview-item").remove(),this.$preview.hide(),this.$uploadArea.show(),this.hasMore=0,this.libBase=0,this.query=null,this.insertColIndex=0,this.loadingList=!1,this.libInsertArr=[],this.$list.find("list-col").empty(),this.$list.hide(),this.$libLoading.hide(),this.$libNoResult.hide(),this.$libDefault.show()}},{key:"bindEvent",value:function(){var i=this,e=this;this.$el.on("click",".insert-image-close, .insert-image-button .button-cancel",function(){e.hide()}).on("click",".insert-image-button .button-ok",e.uploadFinish.bind(e)).on("click",".preview-item .preview-delete",function(t){var a=_commonWidgetJsUtilTangramTangramJs2["default"](t.currentTarget),s=a.parent(".preview-item");s.find("img").hasClass("finish")&&(e.loadedCount-=1,e.$previewTip.text("共"+e.loadedCount+"张上传成功")),s.remove(),e.fileCount-=1,e.$preview.find(".preview-item").size()||(e.$preview.hide(),e.$uploadArea.show()),e.fileCount<10&&i.$previewUpload.show()}).on("click",".insert-image-tab .tab-item",function(i){var t=_commonWidgetJsUtilTangramTangramJs2["default"](i.currentTarget),a=t.data("type");a&&e.switchTab(a)}).on("click",".panel-lib .search-btn",e.searchPic.bind(e)).on("keyup",".panel-lib .search-input",function(i){13===i.keyCode&&e.searchPic()}).on("click",".panel-lib .content-list .img-item-wrapper",function(i){var t=e.libInsertArr,a=_commonWidgetJsUtilTangramTangramJs2["default"](i.currentTarget),s=a.find(".item-select"),n=void 0;if(s.size()){n=Number(s.find(".select-num").text())-1,s.remove(),t.splice(n,1);for(var o=n;o<t.length;o++){var l=t[o].find(".select-num"),r=Number(l.text());l.text(r-1)}}else{if(t.length>=10)return void _commonWidgetJsUiPopTipPopTipJs2["default"]("一次最多添加10张图片");n=t.length+1,a.append('<div class="item-select"><span class="select-num">'+n+"</span></div>"),t.push(a)}}),this.$el.find(".panel-lib .content-list").scroll(function(){if(e.hasMore){{var i=e.$list;i.height(),i[0].scrollHeight}i.height()+i.scrollTop()>i[0].scrollHeight-150&&e.getPicList()}}),setTimeout(function(){var i=window.frames.ueditor_iframe;i&&!function(){var e=i.document;_commonWidgetJsUtilTangramTangramJs2["default"](e).ready(function(){_commonWidgetJsUtilTangramTangramJs2["default"](e).on("mouseover",".imgByInsert",function(){_commonWidgetJsUtilTangramTangramJs2["default"](this).find(".delete").show()}),_commonWidgetJsUtilTangramTangramJs2["default"](e).on("mouseleave",".imgByInsert",function(){_commonWidgetJsUtilTangramTangramJs2["default"](this).find(".delete").hide()}),_commonWidgetJsUtilTangramTangramJs2["default"](e).on("click",".imgByInsert .delete",function(i){i.preventDefault(),_commonWidgetJsUtilTangramTangramJs2["default"](this).parents("p").remove()})})}()},1500)}},{key:"searchPic",value:function(){if(!this.loadingList){var i=_commonWidgetJsUtilTangramTangramJs2["default"].trim(this.$libInput.val());i&&(this.$libDefault.hide(),this.$libNoResult.hide(),this.$list.show(),this.libBase=0,this.hasMore=0,this.$cols.each(function(i,e){_commonWidgetJsUtilTangramTangramJs2["default"](e).empty()}),this.query=i,this.getPicList())}}},{key:"getPicList",value:function(){if(!this.loadingList){this.loadingList=!0,this.$libLoading.show();var i=this;_commonWidgetJsUtilTangramTangramJs2["default"].ajax({type:"GET",url:"/mybaby/ajax/picquery",data:{pn:this.libBase,rn:this.libRn,query:this.query},timeout:3e4,dataType:"json",success:function(e){i.hasMore=e.data.hasMore,i.viewStatus&&0===e.errNo&&e.data&&e.data.picList&&e.data.picList.length?!function(){i.libBase+=i.libRn;var t=i.$cols,a=i.colNum,s=[],n=[];e.data.picList.forEach(function(i){var e=_commonWidgetJsUtilTangramTangramJs2["default"]('<div class="img-item-wrapper"></div>'),t=new Image,a=_commonWidgetJsUtilTangramTangramJs2["default"].Deferred();t.onload=function(){a.resolve()},t.onerror=function(){a.resolve()},n.push(a),t.className="img-item",t.src=i.bos_url+"@w_200",t.setAttribute("data-src",i.bos_url),_commonWidgetJsUtilTangramTangramJs2["default"](t).attr("data-resid",i.res_id),e.append(t),s.push(e)}),_commonWidgetJsUtilTangramTangramJs2["default"].when.apply(_commonWidgetJsUtilTangramTangramJs2["default"],n).then(function(){s.forEach(function(e){var s=void 0,n=void 0;do s=t.eq(i.insertColIndex),i.insertColIndex=++i.insertColIndex%a,n=t.eq(i.insertColIndex);while(s.height()>n.height());s.append(e)}),i.loadingList=!1,i.$libLoading.hide()})}():(i.loadingList=!1,i.$libLoading.hide(),i.viewStatus&&(0===e.errNo?0===i.libBase&&(i.$list.hide(),i.$libNoResult.show()):_commonWidgetJsUiPopTipPopTipJs2["default"]("加载失败~"+ +e.errstr)))},error:function(){i.loadingList=!1,i.$libLoading.hide(),i.viewStatus&&(0===i.libBase&&i.$list.hide(),_commonWidgetJsUiPopTipPopTipJs2["default"]("加载失败~"+ +res.errstr))}})}}},{key:"initUploadFn",value:function(i){this.hasInit=!0;var e=(this.UE,this.$uploadArea),t=this.$preview,a=this.$previewUpload,s=this.$previewTip,n=i.getOpt("imageAllowFiles"),o=i.getOpt("imageUrl")||"/mybaby/ajax/picture",l=(i.getOpt("imageMaxSize")||20971520,i.getOpt("imageUploadName")||"image"),r=i.getOpt("imageUploadParams"),d=this,c=!1,m=_commonWidgetJsUtilWebuploaderWebuploaderMinJs2["default"].create({auto:!0,server:o,pick:{id:d.$el.find(".local-upload-btn")[0]},thumb:{width:r.width,height:r.height,allowMagnify:!1,crop:!1},compress:!1,fileVal:l,duplicate:!0,accept:{title:"Images",extensions:"gif,jpg,jpeg,png,bmp",mimeTypes:"image/gif,image/jpg,image/jpeg,image/png,image/bmp"},formData:r});m.on("beforeFileQueued",function(e){if(d.fileCount>=10)return _commonWidgetJsUiPopTipPopTipJs2["default"]("一次最多添加10张图片"),!1;var t=e.name?e.name.substr(e.name.lastIndexOf(".")):"";return(n.join("")+".").indexOf(t.toLowerCase()+".")<0?(_commonWidgetJsUiPopTipPopTipJs2["default"](""+i.getLang("simpleupload.exceedTypeError")+(e.name?"("+e.name+")":"")),!1):(d.fileCount+=1,void(d.fileCount>=10&&a.hide()))}),m.on("fileQueued",function(s){m.makeThumb(s,function(n,o){e.hide(),t.show(),c||(m.addButton({id:a[0]}),c=!0);var l=['<div class="preview-item">','<span class="preview-delete iknow-ueditor-icons"></span>','<div class="preview-loading">','<div class="loading-animation">','<span class="animation-white"></span><span class="animation-green"></span>',"</div>","</div>",'<img class="preview-img" id="ueditor-preview-img-'+s.id+'" src="'+(n?i.getOpt("waitImageUrl"):o)+'" />','<div class="preview-error">','<div class="error-msg">上传失败</div>','<div class="error-retry">重试</div>',"</div>","</div>"];a.before(l.join(""))})}),m.on("uploadSuccess",function(i,e){var a=t.find("#ueditor-preview-img-"+i.id);if(a.size()&&d.viewStatus){var n=a.parent();e.errNo+""=="0"&&e.url?setTimeout(function(){var o=t.find("#ueditor-preview-img-"+i.id);o.size()&&(n.find(".preview-loading").hide(),d.loadedCount+=1,s.text("共"+d.loadedCount+"张上传成功"),a.removeAttr("id"),a.attr("src",e.url),a.attr("data-resid",e.res_id),a.addClass("finish"))},1e3):(_commonWidgetJsUiPopTipPopTipJs2["default"]("上传失败！"),n.find(".preview-error").show().click(function(e){_commonWidgetJsUtilTangramTangramJs2["default"](e.currentTarget).hide(),n.find(".preview-loading").show(),m.retry(i)}))}})}},{key:"uploadFinish",value:function(){var i=this,e=this.editor,t=(this.UE,this.tabs.current),a=this;if(t===localTabName){var s=this.$preview.find(".preview-item");s.each(function(i,t){var s=_commonWidgetJsUtilTangramTangramJs2["default"](t),n=s.find("img");if(n.hasClass("finish")){var o=n.attr("src"),l='<p><em class="imgByInsert"><img src="'+o+'"><span class="delete"></span></em></p>';e.execCommand("inserthtml",l),s.remove(),a.fileCount-=1,a.loadedCount-=1,a.$previewTip.text("共"+a.loadedCount+"张上传成功")}}),this.$preview.find(".preview-item").size()||(this.$preview.hide(),this.$uploadArea.show()),this.fileCount<10&&this.$previewUpload.show(),this.hide()}else if(t===libTabName){var n=function(){if(i.libInserting)return{v:void 0};i.libInserting=!0;var t=[],s=[];i.$libLoading.show(),i.libInsertArr.forEach(function(i){var n=i.find(".img-item").data("src"),o=i.find(".img-item").data("resid"),l=_commonWidgetJsUtilTangramTangramJs2["default"].Deferred(),r=_commonWidgetJsUtilTangramTangramJs2["default"].Deferred();setTimeout(function(){_commonWidgetJsUtilTangramTangramJs2["default"].ajax({type:"POST",url:"/mybaby/ajax/picresave",data:{bos_url:n,resid:o},timeout:3e4,dataType:"json",success:function(t){0===t.errNo&&t.data&&t.data.url?!function(){var s=a.libInsertArr,n=i.find(".item-select"),d=Number(n.find(".select-num").text())-1;n.remove(),s.splice(d,1);for(var c=d;c<s.length;c++){var m=s[c].find(".select-num"),u=Number(m.text());m.text(u-1)}var p=new Image,g=a.needHttpsAutoTrans?https.autoTrans(t.data.url):t.data.url;p.onload=p.onerror=p.onabort=function(){r.resolve(),p=null},p.src=g,setTimeout(function(){l.resolve(),e.execCommand("inserthtml",'<p class="'+imgFromBjhAttr+' imgByInsert" data-resid="'+o+'"><em class="imgByInsert"><img src="'+g+'" /><span class="delete"></span></em></p>')},1e3)}():(l.resolve(),_commonWidgetJsUiPopTipPopTipJs2["default"]("图片插入失败"+t.errstr))},error:function(){l.resolve(),_commonWidgetJsUiPopTipPopTipJs2["default"]("图片插入失败"+res.errstr)}})},10),t.push(l),s.push(r)}),_commonWidgetJsUtilTangramTangramJs2["default"].when.apply(_commonWidgetJsUtilTangramTangramJs2["default"],t).then(function(){a.$libLoading.hide(),a.libInserting=!1,a.hide()}),_commonWidgetJsUtilTangramTangramJs2["default"].when.apply(_commonWidgetJsUtilTangramTangramJs2["default"],s).then(function(){})}();if("object"==typeof n)return n.v}}},{key:"isShowLib",value:function(i){_commonWidgetJsUtilTangramTangramJs2["default"].ajax({type:"get",url:"/mybaby/ajax/logininfo",dataType:"json",success:function(e){0===e.errno&&e.data.picWhite&&i.show()}})}}]),i}();exports["default"]=InsertImage,module.exports=exports["default"]});